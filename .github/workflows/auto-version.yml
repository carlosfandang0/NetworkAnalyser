name: Auto-increment Version

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'lib/**'
      - 'include/**'
      - 'platformio.ini'

permissions:
  contents: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Increment build number
        run: |
          # Extract base version (e.g., "1.0" from "1.0" or "1.0.123")
          CURRENT_VERSION=$(grep '#define APP_VERSION' src/main.cpp | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"
          
          # Check if version has build number already
          BUILD_COUNT=$(echo $CURRENT_VERSION | grep -o '\.' | wc -l)
          
          if [ $BUILD_COUNT -eq 1 ]; then
            # Format is "1.0" - add first build number
            BASE_VERSION=$CURRENT_VERSION
            NEW_VERSION="$BASE_VERSION.1"
          else
            # Format is "1.0.123" - extract base and increment build
            BASE_VERSION=$(echo $CURRENT_VERSION | cut -d. -f1,2)
            BUILD_NUM=$(echo $CURRENT_VERSION | cut -d. -f3)
            NEW_BUILD=$((BUILD_NUM + 1))
            NEW_VERSION="$BASE_VERSION.$NEW_BUILD"
          fi
          
          echo "New version: $NEW_VERSION"
          
          # Update version in main.cpp
          sed -i "s/#define APP_VERSION \".*\"/#define APP_VERSION \"$NEW_VERSION\"/" src/main.cpp
          
          # Save for next step
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Commit and push build number
        run: |
          if git diff --quiet src/main.cpp; then
            echo "No version change detected; skipping commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/main.cpp
          git commit -m "Auto-increment build to ${{ env.NEW_VERSION }} [skip ci]"
          git push
